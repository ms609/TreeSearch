% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/StepsToLength.R
\name{StepsToLength}
\alias{StepsToLength}
\title{Calculate Expected Length from Fitch Step Count}
\usage{
StepsToLength(nTip, steps, states)
}
\arguments{
\item{nTip}{Integer. The number of leaves (tips) in the tree.}

\item{steps}{Numeric. The Fitch parsimony score of a tree (denoted \eqn{c} in the math).}

\item{states}{Integer. The number of possible tokens (states, denoted \eqn{k} in the math).}
}
\value{
Numeric. The estimated total expected number of steps. Returns \code{NaN} if the input parsimony score is too high to be physically possible under the model.
}
\description{
Calculates the estimated total expected number of evolutionary steps
(substitutions) on a phylogenetic tree, given the observed \strong{Fitch parsimony score}.
This function applies the \strong{Mk (Markov k-state) model correction}, which is the
continuous-time equivalent of the \strong{Jukes-Cantor correction} for discrete,
multi-state characters on a tree. It aims to estimate the true number of steps
that occurred, accounting for homoplasy (the "parsimony gap").
}
\details{
The formula is derived by inverting the expected mean pairwise distance function
of the continuous-time Mk model, under the strong simplifying assumption that
all edges in the tree are of equal length, \eqn{t}, and that the total observed
Fitch parsimony score \eqn{c} is proportional to the total expected differences
across all edges.

Let:
\itemize{
\item \eqn{N_{actual}} be the total expected number of steps (substitutions).
\item \eqn{c} be the observed Fitch parsimony score (\code{steps} input).
\item \eqn{e} be the total number of edges (\code{edges} calculated as \eqn{2 \cdot nTip - 2}).
\item \eqn{k} be the number of possible tokens (\code{states} input).
\item \eqn{P_{obs} = c/e} be the observed proportion of change per edge.
}

The estimated corrected length \eqn{\hat{t}} (expected substitutions per site) for a
single edge under the Mk model is:
\deqn{\hat{t} = -\frac{k-1}{k} \ln\left(1 - \frac{k}{k-1} \cdot P_{obs}\right)}

The total expected steps, \eqn{N_{actual}}, is the sum of these estimated edge lengths:
\deqn{N_{actual} = e \cdot \hat{t}}

Substituting \eqn{P_{obs}} and \eqn{\hat{t}} yields the implemented formula:
\deqn{\mathbf{N_{actual}} = -\frac{e(k-1)}{k} \ln\left(1 - \frac{c k}{e(k-1)}\right)}

\strong{Limitations and Caveats:}
\itemize{
\item \strong{Parsimony Gap:} This formula is an approximation. The Fitch score (\eqn{c}) is only a \strong{lower bound} estimate of the true changes, especially for small trees, which causes the output \eqn{N_{actual}} to be underestimated.
\item \strong{Assumptions:} The formula assumes all tree edges are of \strong{equal length} and ignores the tree's \strong{topology}.
\item \strong{Maximum Parsimony Limit:} The formula returns non-finite values (or issues) when the input \eqn{c} approaches the model's theoretical saturation point, \eqn{c_{limit} = e(k-1)/k}. Since the biological maximum Fitch score \eqn{c_{max}} is often lower than \eqn{c_{limit}}, the function may produce very large results when \eqn{c} is near its maximum.
}
}
\examples{
tree <- TreeTools::BalancedTree(8)
# This two-state character requires two changes to fit on the tree
char <- StringToPhyDat("11100000")
PlotCharacter(tree, char)
steps <- CharacterLength(tree, char)

# The 'true' number of steps is likely greater than two, as Fitch parsimony
# gives a lower bound on the number of steps. 
StepsToLength(tree, steps, 2) # = 2.355
}
